<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Trustworthy Model Registry</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #0f172a;
      color: #e5e7eb;
    }
    body {
      margin: 0;
      padding: 1.5rem;
    }
    h1, h2, h3 {
      color: #f9fafb;
    }
    .page {
      max-width: 1100px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 1.5rem;
    }
    .card {
      background-color: #1f2937;
      border-radius: 0.75rem;
      padding: 1rem 1.25rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.4);
      margin-bottom: 1rem;
    }
    label {
      display: block;
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }
    input[type="text"],
    input[type="password"],
    input[type="file"],
    input[type="search"],
    select {
      width: 100%;
      margin-top: 0.25rem;
      padding: 0.35rem 0.5rem;
      border-radius: 0.4rem;
      border: 1px solid #4b5563;
      background: #111827;
      color: #f9fafb;
      font-size: 0.9rem;
    }
    input::file-selector-button {
      border: none;
      padding: 0.3rem 0.6rem;
      border-radius: 0.4rem;
      margin-right: 0.5rem;
      background: #2563eb;
      color: white;
      cursor: pointer;
    }
    button {
      margin-top: 0.75rem;
      padding: 0.4rem 0.9rem;
      border-radius: 0.5rem;
      border: none;
      font-size: 0.9rem;
      cursor: pointer;
      background: #2563eb;
      color: white;
    }
    button.secondary {
      background: #4b5563;
    }
    button.danger {
      background: #b91c1c;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .row {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      align-items: center;
    }
    .badge {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #111827;
      border: 1px solid #4b5563;
    }
    .badge.sensitive {
      border-color: #f97316;
      color: #fed7aa;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.75rem;
      font-size: 0.9rem;
    }
    th, td {
      padding: 0.45rem 0.5rem;
      border-bottom: 1px solid #374151;
      text-align: left;
    }
    tr:hover {
      background: #111827;
    }
    .status {
      min-height: 1.4rem;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }
    .status.ok {
      color: #22c55e;
    }
    .status.error {
      color: #f97316;
    }
    .pill {
      font-size: 0.8rem;
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      border: 1px solid #4b5563;
    }
    .pill.logged-in {
      border-color: #22c55e;
      color: #bbf7d0;
    }
    .pill.logged-out {
      border-color: #9ca3af;
      color: #e5e7eb;
    }
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      white-space: nowrap;
      border: 0;
    }
    @media (max-width: 800px) {
      .page {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header class="card" aria-label="Registry header">
    <div class="row" style="justify-content: space-between;">
      <div>
        <h1 style="margin: 0;">Trustworthy Model Registry</h1>
        <p style="margin: 0.2rem 0 0; font-size: 0.9rem; color: #9ca3af;">
          Upload, rate, and download models with access control and sensitivity tracking.
        </p>
      </div>
      <div>
        <span id="login-status-pill" class="pill logged-out">
          Logged out
        </span>
      </div>
    </div>
  </header>

  <main class="page">
    <!-- Left column: Auth + Upload -->
    <section aria-label="Authentication and upload">
      <!-- Auth card -->
      <section class="card" aria-labelledby="auth-title">
        <h2 id="auth-title">Authentication</h2>
        <p style="font-size: 0.85rem; color: #9ca3af;">
          Log in to get a token. All protected endpoints will use this token automatically.
        </p>

        <label for="username-input">Username</label>
        <input id="username-input" type="text" autocomplete="username" />

        <label for="password-input">Password</label>
        <input id="password-input" type="password" autocomplete="current-password" />

        <div class="row">
          <button id="login-button">Log in</button>
          <button id="logout-button" class="secondary">Log out</button>
        </div>

        <p id="auth-status" class="status" aria-live="polite"></p>
      </section>

      <!-- Upload card -->
      <section class="card" aria-labelledby="upload-title">
        <h2 id="upload-title">Upload Model</h2>
        <p style="font-size: 0.85rem; color: #9ca3af;">
          Upload a zipped model package. Some roles may be required.
        </p>

        <label for="model-name-input">Model name</label>
        <input id="model-name-input" type="text" placeholder="e.g., mnist-cnn" />

        <label class="row" style="margin-top: 0.5rem;">
          <input id="model-sensitive-input" type="checkbox" />
          <span style="font-size: 0.85rem; margin-left: 0.25rem;">
            Mark this model as <strong>sensitive</strong> (frontend-only for now)
          </span>
        </label>

        <label for="model-file-input">Model package (.zip)</label>
        <input id="model-file-input" type="file" accept=".zip" />

        <button id="upload-button">Upload model</button>

        <p id="upload-status" class="status" aria-live="polite"></p>
      </section>
    </section>

    <!-- Right column: List + actions -->
    <section aria-label="Models list and actions">
      <section class="card" aria-labelledby="models-title">
        <div class="row" style="justify-content: space-between; align-items: flex-end;">
          <div>
            <h2 id="models-title" style="margin-bottom: 0.25rem;">Models</h2>
            <p style="font-size: 0.85rem; color: #9ca3af; margin: 0;">
              Search, list, and download models from the registry.
            </p>
          </div>
          <div class="row">
            <label for="search-input" style="margin-top: 0;">
              <span class="sr-only">Search by name or regex</span>
              <input id="search-input" type="search" placeholder="Search models…" />
            </label>
            <button id="refresh-button" class="secondary">Refresh</button>
          </div>
        </div>

        <p id="models-status" class="status" aria-live="polite"></p>

        <div style="max-height: 400px; overflow-y: auto; margin-top: 0.25rem;">
          <table aria-label="Model list">
            <thead>
              <tr>
                <th>Name</th>
                <th>Type</th>
                <th>Sensitive</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="models-tbody">
              <!-- Rows inserted by JS -->
            </tbody>
          </table>
        </div>
      </section>
    </section>
  </main>

  <script>
  // --- CONFIG ---
  const API_BASE_URL = "https://2047fz40z1.execute-api.us-east-1.amazonaws.com";

  const $ = (id) => document.getElementById(id);

  const loginStatusPill = $("login-status-pill");
  const authStatus = $("auth-status");
  const uploadStatus = $("upload-status");
  const modelsStatus = $("models-status");
  const modelsTbody = $("models-tbody");

  function setStatus(el, msg, type = "") {
    el.textContent = msg || "";
    el.classList.remove("ok", "error");
    if (type) el.classList.add(type);
  }

  // --- Token management ---
  function getToken() {
    return window.localStorage.getItem("tmr_token") || "";
  }

  function setToken(token, username) {
    if (token) {
      window.localStorage.setItem("tmr_token", token); // token includes "bearer ..."
      window.localStorage.setItem("tmr_username", username || "");
      loginStatusPill.textContent = `Logged in as ${username || "user"}`;
      loginStatusPill.classList.remove("logged-out");
      loginStatusPill.classList.add("logged-in");
    } else {
      window.localStorage.removeItem("tmr_token");
      window.localStorage.removeItem("tmr_username");
      loginStatusPill.textContent = "Logged out";
      loginStatusPill.classList.remove("logged-in");
      loginStatusPill.classList.add("logged-out");
    }
  }

  function initAuthState() {
    const token = getToken();
    const username = window.localStorage.getItem("tmr_username") || "";
    if (token) {
      loginStatusPill.textContent = `Logged in as ${username || "user"}`;
      loginStatusPill.classList.add("logged-in");
      loginStatusPill.classList.remove("logged-out");
    } else {
      loginStatusPill.textContent = "Logged out";
      loginStatusPill.classList.remove("logged-in");
      loginStatusPill.classList.add("logged-out");
    }
  }

  // --- API wrapper ---
  async function apiFetch(path, options = {}) {
    const url = API_BASE_URL.replace(/\/$/, "") + path;
    const headers = new Headers(options.headers || {});

    const resp = await fetch(url, { ...options, headers });

    const contentType = resp.headers.get("Content-Type") || "";
    let data = null;

    if (contentType.includes("application/json")) {
      data = await resp.json().catch(() => null);
    } else {
      data = await resp.text().catch(() => null);
    }

    if (!resp.ok) {
      const errMsg =
        (data && data.detail) ||
        (typeof data === "string" ? data : "") ||
        `Request failed with status ${resp.status}`;
      throw new Error(errMsg);
    }

    return { data, headers: resp.headers };
  }

  function authHeaders() {
    const token = getToken();
    // autograder expects X-Authorization: bearer <jwt>
    return token ? { "X-Authorization": token } : {};
  }

  // --- Small helpers ---
  function isProbablyUrl(s) {
    try {
      const u = new URL(s);
      return u.protocol === "http:" || u.protocol === "https:";
    } catch {
      return false;
    }
  }

  function normalizeType(t) {
    const x = String(t || "").toLowerCase();
    if (x === "dataset") return "dataset";
    if (x === "code") return "code";
    return "model";
  }

  // --- Auth handlers (AUTOGRADER) ---
  $("login-button").addEventListener("click", async () => {
    const username = $("username-input").value.trim();
    const password = $("password-input").value;

    if (!username || !password) {
      setStatus(authStatus, "Username and password required.", "error");
      return;
    }

    setStatus(authStatus, "Logging in…");
    try {
      const body = JSON.stringify({
        User: { name: username },
        Secret: { password: password },
      });

      const { data: tokenText } = await apiFetch("/authenticate", {
        method: "PUT",
        body,
        headers: { "Content-Type": "application/json" },
      });

      const token = String(tokenText || "").trim();
      if (!token.toLowerCase().startsWith("bearer ")) {
        throw new Error("Login failed: backend did not return a bearer token.");
      }

      setToken(token, username);
      setStatus(authStatus, "Login successful.", "ok");
      loadModels();
    } catch (err) {
      console.error(err);
      setToken("", "");
      setStatus(authStatus, String(err.message || err), "error");
    }
  });

  $("logout-button").addEventListener("click", () => {
    // Autograder API doesn't provide logout; clearing local token is enough.
    setToken("", "");
    setStatus(authStatus, "Logged out (local token cleared).", "ok");
    cachedModels = [];
    renderModels([]);
    setStatus(modelsStatus, "Log in to load models.", "error");
  });

  // --- Repurpose Upload UI to "Register by URL" ---
  function retrofitUploadUI() {
    // Change the "Model package (.zip)" input into a plain text URL input (same element ID).
    const fileInput = $("model-file-input");
    if (fileInput) {
      try {
        fileInput.type = "text";
      } catch {
        // Some browsers might block changing file->text; fallback handled below.
      }
      fileInput.value = "";
      fileInput.removeAttribute("accept");
      fileInput.setAttribute("placeholder", "https://huggingface.co/... or https://github.com/...");

      // Update its label text if present
      const fileLabel = document.querySelector('label[for="model-file-input"]');
      if (fileLabel) fileLabel.textContent = "Model URL (HuggingFace / GitHub)";
    }

    // Update the description text to match URL-based flow
    const uploadTitle = document.querySelector("#upload-title");
    if (uploadTitle) uploadTitle.textContent = "Register Model";

    // Also adjust the helper paragraph (the first <p> inside upload card)
    const uploadCard = uploadTitle ? uploadTitle.closest(".card") : null;
    if (uploadCard) {
      const ps = uploadCard.querySelectorAll("p");
      if (ps && ps.length > 0) {
        ps[0].textContent =
          "Register a model/dataset/code by URL. The registry will store metadata and allow rating via the backend.";
      }
    }

    // Change the button label
    const uploadBtn = $("upload-button");
    if (uploadBtn) uploadBtn.textContent = "Register";
  }

  // --- Register handler (AUTOGRADER) ---
  $("upload-button").addEventListener("click", async () => {
    const token = getToken();
    if (!token) {
      setStatus(uploadStatus, "You must be logged in to register an artifact.", "error");
      return;
    }

    const nameOrHint = $("model-name-input").value.trim();
    const urlInput = $("model-file-input");
    const urlValue = (urlInput && urlInput.value ? urlInput.value.trim() : "");

    if (!urlValue) {
      setStatus(uploadStatus, "Please paste a URL to register.", "error");
      return;
    }
    if (!isProbablyUrl(urlValue)) {
      setStatus(uploadStatus, "That doesn't look like a valid http(s) URL.", "error");
      return;
    }

    // If user typed something like "dataset:" or "code:" allow quick override, else assume "model"
    // Example: "dataset" in name field -> dataset type
    let artifactType = "model";
    const lower = nameOrHint.toLowerCase();
    if (lower === "dataset" || lower.startsWith("dataset ")) artifactType = "dataset";
    if (lower === "code" || lower.startsWith("code ")) artifactType = "code";

    setStatus(uploadStatus, "Registering…");

    try {
      // autograder endpoint: POST /artifact/{artifact_type}
      // Body: { url: "...", name?: "..." }
      const payload = {
        url: urlValue,
      };

      // Optional: if they typed a real name (and it's not the type override), pass it
      if (nameOrHint && nameOrHint !== "dataset" && nameOrHint !== "code" && nameOrHint !== "model") {
        payload.name = nameOrHint;
      }

      const { data } = await apiFetch(`/artifact/${encodeURIComponent(artifactType)}`, {
        method: "POST",
        body: JSON.stringify(payload),
        headers: {
          "Content-Type": "application/json",
          ...authHeaders(),
        },
      });

      // Response includes metadata.id usually
      const newId = data?.metadata?.id || data?.metadata?.ID || "";
      const newName = data?.metadata?.name || data?.metadata?.Name || payload.name || "(registered)";

      setStatus(
        uploadStatus,
        `Registered ${artifactType}: ${newName}${newId ? ` (ID: ${newId})` : ""}`,
        "ok"
      );

      // Clear inputs
      $("model-name-input").value = "";
      if (urlInput) urlInput.value = "";
      $("model-sensitive-input").checked = false;

      loadModels();
    } catch (err) {
      console.error(err);
      setStatus(uploadStatus, String(err.message || err), "error");
    }
  });

  // --- Models list / search ---
  $("refresh-button").addEventListener("click", () => loadModels());
  $("search-input").addEventListener("input", () => filterModels());

  let cachedModels = [];

  function renderModels(models) {
    modelsTbody.innerHTML = "";

    if (!models || models.length === 0) {
      const row = document.createElement("tr");
      const cell = document.createElement("td");
      cell.colSpan = 4;
      cell.textContent = "No models found.";
      cell.style.color = "#9ca3af";
      row.appendChild(cell);
      modelsTbody.appendChild(row);
      return;
    }

    for (const m of models) {
      const tr = document.createElement("tr");

      const name = m.name || "(unnamed)";
      const type = normalizeType(m.type);
      const id = m.id || "";

      const tdName = document.createElement("td");
      tdName.textContent = name;
      tr.appendChild(tdName);

      const tdType = document.createElement("td");
      tdType.textContent = type;
      tr.appendChild(tdType);

      const tdSens = document.createElement("td");
      const badge = document.createElement("span");
      badge.classList.add("badge");
      badge.textContent = "N/A";
      tdSens.appendChild(badge);
      tr.appendChild(tdSens);

      const tdActions = document.createElement("td");
      tdActions.classList.add("row");

      // Details button (fetches artifact)
      const detailsBtn = document.createElement("button");
      detailsBtn.textContent = "Details";
      detailsBtn.classList.add("secondary");
      detailsBtn.addEventListener("click", async () => {
        if (!id) return;
        setStatus(modelsStatus, `Loading details for ${id}…`);
        try {
          const { data } = await apiFetch(`/artifacts/${encodeURIComponent(type)}/${encodeURIComponent(id)}`, {
            method: "GET",
            headers: { ...authHeaders() },
          });

          const url = data?.data?.url || "";
          const meta = data?.metadata || {};
          const pretty = [
            `Name: ${meta.name || meta.Name || name}`,
            `ID: ${meta.id || meta.ID || id}`,
            `Type: ${meta.type || meta.Type || type}`,
            url ? `URL: ${url}` : "",
          ].filter(Boolean).join("\n");

          alert(pretty);
          setStatus(modelsStatus, `Details loaded for ${id}.`, "ok");
        } catch (err) {
          console.error(err);
          setStatus(modelsStatus, String(err.message || err), "error");
        }
      });
      tdActions.appendChild(detailsBtn);

      // Rate button (models only)
      const rateBtn = document.createElement("button");
      rateBtn.textContent = "Rate";
      rateBtn.classList.add("secondary");
      rateBtn.disabled = (type !== "model" || !id);
      rateBtn.addEventListener("click", async () => {
        if (!id) return;
        setStatus(modelsStatus, `Rating model ${id}…`);
        try {
          const { data } = await apiFetch(`/artifact/model/${encodeURIComponent(id)}/rate`, {
            method: "GET",
            headers: { ...authHeaders() },
          });

          // data is a big rating object; show the main fields
          const net = data?.net_score ?? data?.NetScore;
          const bus = data?.bus_factor ?? data?.BusFactor;
          const lic = data?.license ?? data?.LicenseScore;
          const ramp = data?.ramp_up_time ?? data?.RampUp;

          const summary = [
            `net_score: ${net}`,
            `bus_factor: ${bus}`,
            `license: ${lic}`,
            `ramp_up_time: ${ramp}`,
          ].join(" | ");

          setStatus(modelsStatus, `Rated ${id}: ${summary}`, "ok");
        } catch (err) {
          console.error(err);
          setStatus(modelsStatus, String(err.message || err), "error");
        }
      });
      tdActions.appendChild(rateBtn);

      // Open URL button (needs details first; we'll fetch and open)
      const openBtn = document.createElement("button");
      openBtn.textContent = "Open URL";
      openBtn.classList.add("secondary");
      openBtn.disabled = !id;
      openBtn.addEventListener("click", async () => {
        if (!id) return;
        setStatus(modelsStatus, `Fetching URL for ${id}…`);
        try {
          const { data } = await apiFetch(`/artifacts/${encodeURIComponent(type)}/${encodeURIComponent(id)}`, {
            method: "GET",
            headers: { ...authHeaders() },
          });

          const url = data?.data?.url || "";
          if (!url) throw new Error("No URL stored for this artifact.");
          window.open(url, "_blank", "noopener,noreferrer");
          setStatus(modelsStatus, `Opened URL for ${id}.`, "ok");
        } catch (err) {
          console.error(err);
          setStatus(modelsStatus, String(err.message || err), "error");
        }
      });
      tdActions.appendChild(openBtn);

      tr.appendChild(tdActions);
      modelsTbody.appendChild(tr);
    }
  }

  function filterModels() {
    const q = $("search-input").value.trim().toLowerCase();
    if (!q) {
      renderModels(cachedModels);
      return;
    }
    const filtered = cachedModels.filter((m) => {
      const name = (m.name || "").toLowerCase();
      const type = (m.type || "").toLowerCase();
      const id = (m.id || "").toLowerCase();
      return name.includes(q) || type.includes(q) || id.includes(q);
    });
    renderModels(filtered);
  }

  async function loadModels() {
    setStatus(modelsStatus, "Loading models…");

    const token = getToken();
    if (!token) {
      setStatus(modelsStatus, "Log in to load models.", "error");
      cachedModels = [];
      renderModels([]);
      return;
    }

    try {
      // POST /artifacts with wildcard query
      // We'll request all types so the UI still works if you register dataset/code too.
      const body = JSON.stringify([{ name: "*", types: ["model", "dataset", "code"] }]);

      const { data, headers } = await apiFetch("/artifacts", {
        method: "POST",
        body,
        headers: {
          "Content-Type": "application/json",
          ...authHeaders(),
        },
      });

      const items = Array.isArray(data) ? data : [];
      cachedModels = items;

      renderModels(items);
      filterModels();

      // Offset header may be present for pagination
      const offset = headers.get("offset");
      setStatus(
        modelsStatus,
        `Loaded ${items.length} item(s).${offset ? " (More available; backend supports pagination.)" : ""}`,
        "ok"
      );
    } catch (err) {
      console.error(err);
      setStatus(modelsStatus, String(err.message || err), "error");
      cachedModels = [];
      renderModels([]);
    }
  }

  // --- Init ---
  window.addEventListener("DOMContentLoaded", () => {
    initAuthState();
    retrofitUploadUI();
    loadModels();
  });
</script>
</body>
</html>
