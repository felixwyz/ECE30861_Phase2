name: Deploy Backend

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Build Lambda zip
        run: |
          set -e

          python -m pip install --upgrade pip

          # Requirements file: adjust ONLY if your repo stores it elsewhere
          REQ="requirements.txt"
          if [ ! -f "$REQ" ]; then
            echo "ERROR: $REQ not found. If your requirements.txt is elsewhere, update REQ."
            exit 1
          fi

          rm -rf build lambda_deployment.zip
          mkdir -p build

          # Install dependencies into build/ (zip root)
          pip install -r "$REQ" -t build

          # Copy source into build/ (so build/lambda_handler.py exists)
          cp -r src/* build/

          echo "Sanity check: handler file must be at zip root"
          test -f build/lambda_handler.py || (echo "ERROR: build/lambda_handler.py missing" && exit 1)

          # Create zip
          (cd build && zip -r ../lambda_deployment.zip .)

          echo "Built:"
          ls -lh lambda_deployment.zip

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWSKEY }}
          aws-secret-access-key: ${{ secrets.AWSSECRET }}
          aws-region: us-east-1

      - name: Deploy to Lambda
        run: |
          aws lambda update-function-code \
            --function-name tmr-dev-api \
            --zip-file fileb://lambda_deployment.zip
